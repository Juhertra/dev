<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ project_name }} ‚Äî {% block page_title %}{% endblock %}</title>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='tokens.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
  <script src="{{ url_for('static', filename='main.js') }}"></script>
  <script>
    // Provide project context for pages that rely on it
    window.APP_CTX = Object.assign({}, window.APP_CTX || {}, { pid: "{{ pid }}" });
    window.currentProjectId = "{{ pid }}";
  </script>
  <style>
    .app-shell { display:flex; min-height:100vh; }
    .sidebar {
      width: 256px; background: var(--bg2); border-right:1px solid var(--card-b);
      padding: 14px; position: sticky; top:0; height:100vh;
      flex-shrink: 0;
    }
    .sb-title { font-weight:700; color:var(--fg); margin-bottom:6px; }
    .sb-project { color:var(--muted); font-size:.9rem; margin-bottom:12px; }
    .nav { display:flex; flex-direction:column; gap:4px; }
    .nav a {
      display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px;
      color:var(--fg); text-decoration:none;
    }
    .nav a.active { background: rgba(34,211,238,.20); color: var(--accent); }
    .nav .badge {
      margin-left:auto; background: var(--accent); color:#0b1020;
      border-radius:999px; padding:1px 8px; font-size:.75rem;
    }
    .content { flex:1; display:flex; flex-direction:column; min-width:0; }
    .toprow {
      display:flex; align-items:center; gap:8px; padding:10px 16px;
      border-bottom:1px solid var(--card-b); background: var(--bg2);
      flex-wrap: wrap;
    }
    .breadcrumbs { color: var(--muted); font-size:.9rem; }
    .breadcrumbs a { color: var(--muted); text-decoration:none; }
    .breadcrumbs .sep { margin:0 6px; }
    .wrap { padding:16px; min-width:0; }
    #panel { z-index: 1000; } /* keep drawer above content */
    
    /* Responsive breakpoints */
    @media (max-width: 1024px) {
      .sidebar { width: 220px; }
    }
    
    @media (max-width: 768px) {
      .app-shell { flex-direction: column; }
      .sidebar { 
        width: 100%; height: auto; position: static; 
        border-right: none; border-bottom: 1px solid var(--card-b);
      }
      .nav { flex-direction: row; flex-wrap: wrap; gap: 8px; }
      .nav a { flex: 1; min-width: 120px; justify-content: center; }
      .toprow { padding: 8px 12px; }
      .wrap { padding: 12px; }
    }
    
    @media (max-width: 480px) {
      .nav a { min-width: 100px; font-size: 0.9rem; padding: 6px 8px; }
      .toprow { padding: 6px 8px; gap: 4px; }
      .wrap { padding: 8px; }
      .breadcrumbs { font-size: 0.8rem; }
    }
    
    /* Skeleton loading animations */
    .htmx-loading {
      opacity: 0.5;
      pointer-events: none;
    }
    
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    .skeleton-text {
      height: 1rem;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }
    
    .skeleton-button {
      height: 2.5rem;
      width: 6rem;
      border-radius: 6px;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* Toast notifications */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      pointer-events: none;
    }
    
    .toast {
      background: #333;
      color: white;
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 8px;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
      pointer-events: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .toast.success { background: #28a745; }
    .toast.error { background: #dc3545; }
    .toast.warning { background: #ffc107; color: #000; }
    
    /* Accessibility - Focus rings */
    button:focus-visible,
    a:focus-visible,
    input:focus-visible,
    select:focus-visible {
      outline: 2px solid #007bff;
      outline-offset: 2px;
    }
    
    button:focus:not(:focus-visible) {
      outline: none;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <aside class="sidebar" aria-label="Primary">
    <div class="sb-title">Security Toolkit</div>
    <div class="sb-project">{{ project_name }}</div>
    <nav class="nav" role="navigation">
      <a class="{{ 'active' if active_nav=='projects' else '' }}" href="{{ url_for('web.projects_home') }}">üìÇ Projects</a>
      <a class="{{ 'active' if active_nav=='dashboard' else '' }}" href="{{ url_for('web.dashboard_bp.dashboard_page', pid=pid) }}">üìä Dashboard</a>
      <a class="{{ 'active' if active_nav=='tools' else '' }}" href="{{ url_for('web.tools_page', pid=pid) }}">üîß Tools Manager</a>
      <a class="{{ 'active' if active_nav=='explorer' else '' }}" href="{{ url_for('web.project_open', pid=pid) }}">üîç API Explorer</a>
      <a class="{{ 'active' if active_nav=='sitemap' else '' }}" href="{{ url_for('web.site_map_page', pid=pid) }}">üó∫Ô∏è Site Map</a>
      <a class="{{ 'active' if active_nav=='queue' else '' }}" href="{{ url_for('web.queue_page', pid=pid) }}">‚è≥ Test Queue</a>
      <a class="{{ 'active' if active_nav=='active_testing' else '' }}" href="{{ url_for('web.active_testing_page', pid=pid) }}">üî¨ Active Testing</a>
      <a class="{{ 'active' if active_nav=='template_manager' else '' }}" href="{{ url_for('web.template_manager', pid=pid) }}">üìã Template Manager</a>
      <a class="{{ 'active' if active_nav=='history' else '' }}" href="{{ url_for('web.sends_page', pid=pid) }}">üïë History</a>
      <a class="{{ 'active' if active_nav=='findings' else '' }}" href="{{ url_for('web.findings_page', pid=pid) }}">üö® Vulnerabilities{% if counts and counts.total %}<span class="badge">{{ counts.total }}</span>{% endif %}</a>
      <a class="{{ 'active' if active_nav=='metrics' else '' }}" href="/p/{{ pid }}/metrics">üìà Metrics</a>
      <a class="{{ 'active' if active_nav=='patterns' else '' }}" href="{{ url_for('web.patterns_page', pid=pid) }}">‚öñÔ∏è Detection Rules</a>
      <a class="{{ 'active' if active_nav=='reports' else '' }}" href="{{ url_for('web.reports_page', pid=pid) }}">üìä Security Reports</a>
    </nav>
  </aside>

  <main class="content">
    <div class="toprow">
      <div class="breadcrumbs" aria-label="Breadcrumb">
        {% block breadcrumbs %}
          <a href="{{ url_for('web.projects_home') }}">Projects</a>
          <span class="sep">‚Ä∫</span>
          <a href="{{ url_for('web.project_open', pid=pid) }}">{{ project_name }}</a>
          <!-- page appends more segments -->
        {% endblock %}
      </div>
      <span style="flex:1"></span>
      <button id="theme" class="btn" onclick="setTheme(getTheme()==='light'?'dark':'light')">üåô</button>
    </div>

    <div class="wrap">
      {% block content %}{% endblock %}
    </div>
  </main>

  <div id="global-indicator" class="htmx-indicator" style="display:none; position:fixed; top:10px; right:10px; z-index:10000;">
    <div class="spinner"></div>
  </div>

  <!-- Drawer Overlay -->
  <div id="panel-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9998;"
       onclick="closePanel()"></div>

  <!-- Drawer Panel -->
  <aside id="panel" aria-hidden="true"
         style="position:fixed !important; top:0 !important; right:0 !important; width:520px; max-width:95vw; 
                height:100vh !important; max-height:100vh !important; min-height:100vh !important;
                background:var(--bg); border-left:1px solid var(--card-b); box-shadow:-12px 0 24px rgba(0,0,0,.25);
                transform:translateX(100%); transition:transform .18s ease; z-index:9999; 
                display:flex; flex-direction:column; overflow:hidden;">
    <header style="display:flex; align-items:center; gap:8px; padding:12px 14px; border-bottom:1px solid var(--card-b); flex-wrap:wrap; flex-shrink:0;">
      <span id="panel-chip" class="chip GET">GET</span>
      <strong id="panel-title" style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0;">Details</strong>
      <button class="btn ghost" type="button" onclick="closePanel()">Close</button>
    </header>
    <div id="panel-url-display" class="muted" style="padding:8px 14px; display:none; word-break:break-all; flex-shrink:0;"></div>
    <div id="panel-body" class="panel-body" style="flex:1; overflow:auto; padding:10px 14px; min-height:0; height:calc(100vh - 120px); max-height:calc(100vh - 120px);"></div>
  </aside>
  
  <style>
    /* Responsive drawer adjustments */
    @media (max-width: 768px) {
      #panel { 
        width: 100vw !important; 
        max-width: 100vw !important; 
        right: 0 !important;
      }
      #panel header { padding: 8px 12px; }
      #panel-body { padding: 8px 12px; }
      #panel-url-display { padding: 6px 12px; }
    }
    
    @media (max-width: 480px) {
      #panel header { 
        padding: 6px 8px; 
        gap: 4px;
      }
      #panel-title { font-size: 0.9rem; }
      #panel-body { padding: 6px 8px; }
      #panel-url-display { padding: 4px 8px; font-size: 0.8rem; }
    }
  </style>

  <!-- Toast Container -->
  <div id="toast-container" aria-live="polite"></div>
  
</div>
</body>
</html>
