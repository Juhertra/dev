{% extends "_layout.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="wrap">
    <!-- Header Section -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="row" style="justify-content: space-between; align-items: center;">
            <div>
                <h1 style="margin: 0 0 8px 0;">Security Dashboard</h1>
                <div class="muted">Actionable metrics to drive security decisions</div>
            </div>
            <div>
                <a href="{{ url_for('web.active_testing_page', pid=pid) }}" class="btn primary">
                    <i class="fas fa-play"></i> Start Active Testing
                </a>
            </div>
        </div>
    </div>

    <!-- Coverage Card -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="row" style="align-items: center; gap: 24px;">
            <div style="position: relative; width: 120px; height: 120px;">
                <svg width="120" height="120" style="transform: rotate(-90deg);">
                    <circle cx="60" cy="60" r="50" stroke="var(--card-b)" stroke-width="8" fill="none"/>
                    <circle cx="60" cy="60" r="50" stroke="var(--accent)" stroke-width="8" fill="none"
                            stroke-dasharray="{{ (metrics.coverage.tested_pct * 3.14) | round(0) }} 314"
                            stroke-dashoffset="0"/>
                </svg>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; line-height: 1;">{{ "%.0f"|format(metrics.coverage.tested_pct) }}%</div>
                    <div class="muted" style="font-size: 12px;">Coverage</div>
                </div>
            </div>
            <div style="flex: 1;">
                <h3 style="margin: 0 0 8px 0;">Test Coverage</h3>
                <div class="muted" style="margin-bottom: 12px;" title="Endpoints with ≥1 run in their dossier">How computed: Endpoints with ≥1 run in their dossier</div>
                <div style="font-size: 18px; font-weight: 600;">
                    {{ metrics.coverage.tested }} / {{ metrics.coverage.total }} endpoints tested
                </div>
                {% if metrics.coverage.total > 0 %}
                <div class="muted" style="margin-top: 8px;">
                    {{ metrics.coverage.total - metrics.coverage.tested }} endpoints untested
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- New Findings & Severity Bar -->
    <div class="row" style="gap: 24px; margin-bottom: 24px;">
        <!-- New Findings -->
        <div class="card" style="flex: 1;">
            <h3 style="margin: 0 0 16px 0;">New Findings</h3>
            <div class="muted" style="margin-bottom: 12px;" title="Findings created in last 24h and 7d">How computed: Findings created in last 24h and 7d</div>
            <div class="row" style="gap: 24px;">
                <div>
                    <div style="font-size: 32px; font-weight: 700; color: var(--err);">{{ metrics.findings.new_24h }}</div>
                    <div class="muted">Last 24h</div>
                </div>
                <div>
                    <div style="font-size: 32px; font-weight: 700; color: var(--accent);">{{ metrics.findings.new_7d }}</div>
                    <div class="muted">Last 7d</div>
                </div>
            </div>
            <div style="margin-top: 16px;">
                <div class="muted">Total: {{ metrics.findings.total }} findings</div>
            </div>
        </div>

        <!-- Severity Bar -->
        <div class="card" style="flex: 1;">
            <h3 style="margin: 0 0 16px 0;">Severity Distribution</h3>
            <div class="muted" style="margin-bottom: 12px;" title="Count of findings by severity level">How computed: Count of findings by severity level</div>
            <div style="display: flex; height: 40px; border-radius: 6px; overflow: hidden; background: var(--card-b);">
                {% set total = metrics.vulns.total %}
                {% if total > 0 %}
                    <div style="flex: {{ metrics.vulns.by_severity.critical }}; background: #dc2626;" title="Critical: {{ metrics.vulns.by_severity.critical }}"></div>
                    <div style="flex: {{ metrics.vulns.by_severity.high }}; background: #f97316;" title="High: {{ metrics.vulns.by_severity.high }}"></div>
                    <div style="flex: {{ metrics.vulns.by_severity.medium }}; background: #eab308;" title="Medium: {{ metrics.vulns.by_severity.medium }}"></div>
                    <div style="flex: {{ metrics.vulns.by_severity.low }}; background: #3b82f6;" title="Low: {{ metrics.vulns.by_severity.low }}"></div>
                    <div style="flex: {{ metrics.vulns.by_severity.info }}; background: #6b7280;" title="Info: {{ metrics.vulns.by_severity.info }}"></div>
                {% endif %}
            </div>
            <div class="row" style="gap: 12px; margin-top: 12px; flex-wrap: wrap;">
                <span class="chip" style="background: #dc2626; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Critical: {{ metrics.vulns.by_severity.critical }}</span>
                <span class="chip" style="background: #f97316; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">High: {{ metrics.vulns.by_severity.high }}</span>
                <span class="chip" style="background: #eab308; color: black; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Medium: {{ metrics.vulns.by_severity.medium }}</span>
                <span class="chip" style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Low: {{ metrics.vulns.by_severity.low }}</span>
                <span class="chip" style="background: #6b7280; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Info: {{ metrics.vulns.by_severity.info }}</span>
            </div>
        </div>
    </div>

    <!-- Top Detectors Table -->
    <div class="card" style="margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0;">Top Detectors by Impact</h3>
        <div class="muted" style="margin-bottom: 12px;" title="Detectors ranked by distinct endpoints impacted">How computed: Detectors ranked by distinct endpoints impacted</div>
        {% if metrics.detectors.top %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Detector</th>
                        <th>Impacted Endpoints</th>
                        <th>Total Occurrences</th>
                        <th>Worst Severity</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detector in metrics.detectors.top %}
                    <tr>
                        <td>
                            <code style="font-size: 14px;">{{ detector.id }}</code>
                        </td>
                        <td>{{ detector.endpoints }}</td>
                        <td>{{ detector.occurrences }}</td>
                        <td>
                            <span class="chip" style="background: {% if detector.worst_severity == 'critical' %}#dc2626{% elif detector.worst_severity == 'high' %}#f97316{% elif detector.worst_severity == 'medium' %}#eab308{% elif detector.worst_severity == 'low' %}#3b82f6{% else %}#6b7280{% endif %}; color: {% if detector.worst_severity == 'medium' %}black{% else %}white{% endif %}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase;">{{ detector.worst_severity }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
            <p style="margin: 0;">No detectors found</p>
        </div>
        {% endif %}
    </div>

    <!-- Top Endpoints Table -->
    <div class="card" style="margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0;">Top Endpoints by Vulnerabilities</h3>
        <div class="muted" style="margin-bottom: 12px;" title="Endpoints ranked by distinct vulnerability types">How computed: Endpoints ranked by distinct vulnerability types</div>
        {% if metrics.endpoints.top %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>Vulnerabilities</th>
                        <th>Worst Severity</th>
                        <th>Last Seen</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for endpoint in metrics.endpoints.top %}
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="chip" style="background: var(--chip-get); color: var(--bg); padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase;">{{ endpoint.method }}</span>
                                <code style="font-size: 14px;">{{ endpoint.path }}</code>
                            </div>
                        </td>
                        <td>{{ endpoint.vulns }}</td>
                        <td>
                            <span class="chip" style="background: {% if endpoint.worst_severity == 'critical' %}#dc2626{% elif endpoint.worst_severity == 'high' %}#f97316{% elif endpoint.worst_severity == 'medium' %}#eab308{% elif endpoint.worst_severity == 'low' %}#3b82f6{% else %}#6b7280{% endif %}; color: {% if endpoint.worst_severity == 'medium' %}black{% else %}white{% endif %}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase;">{{ endpoint.worst_severity }}</span>
                        </td>
                        <td>
                            {% if endpoint.last_seen_at %}
                                <span class="relative-time" title="{{ endpoint.last_seen_at }}">
                                    {{ endpoint.last_seen_at.split('T')[0] }}
                                </span>
                            {% else %}
                                <span class="muted">Never</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn ghost" onclick="openEndpointRuns('{{ endpoint.endpoint_key }}')" style="font-size: 14px;">
                                <i class="fas fa-history"></i> View Runs
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
            <p style="margin: 0;">No vulnerable endpoints found</p>
        </div>
        {% endif %}
    </div>

    <!-- Run Health Strip -->
    <div class="card">
        <h3 style="margin: 0 0 16px 0;">Run Health</h3>
        <div class="muted" style="margin-bottom: 12px;" title="Metrics from recent scan runs">How computed: Metrics from recent scan runs</div>
        <div class="row" style="gap: 32px; align-items: center;">
            <div>
                <div class="muted" style="font-size: 14px;">Last Run</div>
                <div style="font-size: 18px; font-weight: 600;">
                    {% if metrics.runs.last_run_at %}
                        <span class="relative-time" title="{{ metrics.runs.last_run_at }}">
                            {{ metrics.runs.last_run_at.split('T')[0] }}
                        </span>
                    {% else %}
                        <span class="muted">Never</span>
                    {% endif %}
                </div>
            </div>
            <div>
                <div class="muted" style="font-size: 14px;">Runs Last 7d</div>
                <div style="font-size: 18px; font-weight: 600;">{{ metrics.runs.runs_last_7d }}</div>
            </div>
            <div>
                <div class="muted" style="font-size: 14px;">Avg Findings/Run</div>
                <div style="font-size: 18px; font-weight: 600;">{{ "%.1f"|format(metrics.runs.avg_findings_per_run) }}</div>
            </div>
            <div>
                <div class="muted" style="font-size: 14px;">Worst Severity</div>
                <div>
                    <span class="chip" style="background: {% if metrics.runs.worst_severity_last_run == 'critical' %}#dc2626{% elif metrics.runs.worst_severity_last_run == 'high' %}#f97316{% elif metrics.runs.worst_severity_last_run == 'medium' %}#eab308{% elif metrics.runs.worst_severity_last_run == 'low' %}#3b82f6{% else %}#6b7280{% endif %}; color: {% if metrics.runs.worst_severity_last_run == 'medium' %}black{% else %}white{% endif %}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase;">{{ metrics.runs.worst_severity_last_run }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function openEndpointRuns(endpointKey) {
    const method = endpointKey.split(' ')[0];
    const url = endpointKey.split(' ', 1)[1];
    const safeKey = endpointKey.replace(/[^a-zA-Z0-9]/g, '_');
    
    htmx.ajax('GET', `/p/{{ pid }}/sitemap/endpoint/${safeKey}/runs`, {
        target: '#panel-body',
        swap: 'innerHTML'
    });
    
    const drawer = document.getElementById('endpoint-drawer');
    if (drawer) {
        drawer.classList.add('show');
    }
}

// Initialize relative time formatting
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.relative-time').forEach(function(element) {
        const isoTime = element.getAttribute('title');
        if (isoTime) {
            const date = new Date(isoTime);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                element.textContent = 'Today';
            } else if (diffDays === 1) {
                element.textContent = 'Yesterday';
            } else if (diffDays < 7) {
                element.textContent = `${diffDays} days ago`;
            } else {
                element.textContent = date.toLocaleDateString();
            }
        }
    });
});
</script>
{% endblock %}