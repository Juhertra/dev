{% extends "_layout.html" %}
{% set active_nav = 'active_testing' %}

{% block page_title %}Active Testing{% endblock %}

{% block breadcrumbs %}
  {{ super() }}
  <span class="sep">›</span>
  <span>Active Testing</span>
{% endblock %}

{% block content %}

  <!-- Active Testing Header -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:16px">
      <div>
        <h2 style="margin:0">🔬 Active Testing</h2>
        <div class="muted">Run comprehensive security scans on your API endpoints</div>
      </div>
      <div class="row" style="gap:8px">
        <button class="btn ghost" type="button" onclick="checkNucleiStatus()">Check Status</button>
        <button class="btn ghost" type="button" onclick="updateNucleiTemplates()">Update Templates</button>
        <button class="btn primary" type="button" onclick="openTemplateManager()">Template Manager</button>
      </div>
    </div>

    <!-- Nuclei Status -->
    <div id="nuclei-status" class="muted" style="margin-bottom: 16px;">
      Checking Nuclei status...
    </div>
  </div>

  <!-- Workflow Steps -->
  <div class="card">
    <h3 style="margin:0 0 16px">Testing Workflow</h3>
    <div class="workflow-steps">
      <div class="step completed">
        <div class="step-number">1</div>
        <div class="step-content">
          <div class="step-title">Load API Specs</div>
          <div class="step-description">Load OpenAPI/Swagger specifications</div>
        </div>
      </div>
      <div class="step completed">
        <div class="step-number">2</div>
        <div class="step-content">
          <div class="step-title">Add to Test Queue</div>
          <div class="step-description">Select endpoints for testing</div>
        </div>
      </div>
      <div class="step active">
        <div class="step-number">3</div>
        <div class="step-content">
          <div class="step-title">Configure Scan</div>
          <div class="step-description">Set up active testing parameters</div>
        </div>
      </div>
      <div class="step">
        <div class="step-number">4</div>
        <div class="step-content">
          <div class="step-title">Run Scan</div>
          <div class="step-description">Execute security tests</div>
        </div>
      </div>
      <div class="step">
        <div class="step-number">5</div>
        <div class="step-content">
          <div class="step-title">Review Results</div>
          <div class="step-description">Analyze and triage findings</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scan Configuration -->
  <div class="card" id="scan-config-section">
    <h3 style="margin:0 0 16px">Scan Configuration</h3>
    
    <!-- Target Selection -->
    <div style="margin-bottom: 24px;">
      <h4 style="margin:0 0 12px">Target Endpoints</h4>
      <div id="endpoint-summary" class="endpoint-summary">
        <div class="muted">Loading endpoints from queue...</div>
      </div>
      <div style="margin-top: 12px;">
        <a href="{{ url_for('web.queue_page', pid=pid) }}" class="btn ghost">Manage Queue</a>
      </div>
    </div>

    <!-- Scan Parameters -->
    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
      <div>
        <h4 style="margin:0 0 12px">Severity Levels</h4>
        <div class="severity-selector">
          <label class="severity-option">
            <input type="checkbox" name="severity" value="critical" checked>
            <span class="severity-badge critical">Critical</span>
          </label>
          <label class="severity-option">
            <input type="checkbox" name="severity" value="high" checked>
            <span class="severity-badge high">High</span>
          </label>
          <label class="severity-option">
            <input type="checkbox" name="severity" value="medium" checked>
            <span class="severity-badge medium">Medium</span>
          </label>
          <label class="severity-option">
            <input type="checkbox" name="severity" value="low">
            <span class="severity-badge low">Low</span>
          </label>
          <label class="severity-option">
            <input type="checkbox" name="severity" value="info">
            <span class="severity-badge info">Info</span>
          </label>
        </div>
      </div>
      
      <div>
        <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h4 style="margin:0">Template Selection</h4>
          <div style="display:flex;gap:8px">
            <button class="btn ghost" type="button" onclick="openTemplateSidePanel()">Quick Select</button>
            <button class="btn ghost" type="button" onclick="openTemplateManagerModal()">Advanced Manager</button>
          </div>
        </div>
        
        <div class="card" style="padding:12px;margin-bottom:12px">
          <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="muted">Selected Templates:</div>
            <div id="selected-template-count" class="muted">0 templates</div>
          </div>
          <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="muted">Total Endpoints:</div>
            <div id="endpoint-count" class="muted">0 endpoints</div>
          </div>
          <div id="selected-templates-preview" class="selected-templates-list" style="min-height:20px">
            <div class="muted" style="text-align:center;padding:8px">No templates selected. Use "Quick Select" or "Advanced Manager" to choose templates.</div>
          </div>
        </div>
      </div>
    </div>


    <!-- Advanced Options -->
    <details style="margin-bottom: 24px;">
      <summary style="cursor:pointer;padding:8px 0;font-weight:600;">Advanced Options</summary>
      <div style="margin-top:12px;padding:12px;background:var(--bg2);border-radius:8px;">
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
          <div>
            <label>Rate Limit (requests/second)</label>
            <input type="number" id="rate-limit" value="10" min="1" max="100" style="width:100%;margin-top:4px">
          </div>
          <div>
            <label>Timeout (seconds)</label>
            <input type="number" id="timeout" value="30" min="5" max="300" style="width:100%;margin-top:4px">
          </div>
        </div>
      </div>
    </details>

    <!-- Scan Actions -->
    <div class="scan-actions">
      <button class="btn primary" type="button" onclick="runActiveScan()" id="scan-button">
        🚀 Run Active Scan
      </button>
      <button class="btn ghost" type="button" onclick="clearScanConfig()">Clear Config</button>
      <button class="btn ghost" type="button" onclick="saveScanProfile()">Save Profile</button>
    </div>
  </div>

  <!-- Scan Progress & Results -->
  <div class="card" id="scan-results" style="display:none">
    <h3 style="margin:0 0 16px">Scan Results</h3>
    <div id="scan-progress" style="margin-bottom:16px">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="progress-text" id="progress-text">Preparing scan...</div>
      <div class="scan-details" id="scan-details" style="margin-top:8px;font-size:12px;color:var(--muted)">
        <!-- Current endpoint and template info will be shown here -->
        <div id="now-scanning" style="display:none;margin-bottom:8px">
          <strong>Now scanning:</strong> <span id="current-endpoint">-</span> <span id="current-template">-</span>
        </div>
        <div id="run-details-link" style="display:none;margin-bottom:8px">
          <a href="#" id="run-link" target="_blank" style="color:var(--accent);text-decoration:none">
            <i class="fas fa-external-link-alt"></i> Open run details
          </a>
        </div>
      </div>
    </div>
    
    <!-- Live Scan Results -->
    <div id="live-results" style="margin-top:16px;display:none">
      <!-- Top toolbar -->
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="row" style="gap:8px;align-items:center">
          <h4 style="margin:0">Live Results</h4>
          <!-- Counter chips -->
          <div id="live-counters" style="display:flex;gap:6px;flex-wrap:wrap">
            <span class="chip" style="background:var(--ok);color:white;font-size:12px;font-weight:600">Findings: 0</span>
            <span class="chip" style="background:var(--accent);color:var(--bg);font-size:12px;font-weight:600">Endpoints: 0</span>
            <span class="chip" style="background:var(--muted);color:white;font-size:12px;font-weight:600">Duration: 00:00:00</span>
          </div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn ghost" onclick="clearLiveResults()" style="font-size:12px" aria-label="Clear live results">
            <i class="fas fa-trash"></i> Clear
          </button>
          <button class="btn ghost" onclick="togglePauseResume()" id="pause-resume-btn" style="font-size:12px" aria-label="Pause live updates">
            <i class="fas fa-pause"></i> Pause
          </button>
          <button class="btn ghost" onclick="toggleAutoScroll()" id="auto-scroll-btn" style="font-size:12px" aria-label="Toggle auto-scroll">
            <i class="fas fa-arrow-down"></i> Auto-scroll
          </button>
          <button class="btn ghost" onclick="toggleLiveResults()" style="font-size:12px" aria-label="Minimize live results">
            <i class="fas fa-minus"></i> Minimize
          </button>
        </div>
      </div>
      
      <!-- Error banner (hidden by default) -->
      <div id="sse-error-banner" style="display:none;background:var(--err-bg);color:var(--err);padding:8px 12px;border-radius:6px;margin-bottom:8px;font-size:14px">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="sse-error-message">Connection lost. Attempting to reconnect...</span>
      </div>
      
      <!-- Reconnecting ribbon (hidden by default) -->
      <div id="reconnecting-ribbon" style="display:none;background:var(--warn-bg);color:var(--warn);padding:6px 12px;border-radius:4px;margin-bottom:8px;font-size:12px;text-align:center">
        <i class="fas fa-sync-alt fa-spin"></i> Reconnecting...
      </div>
      
      <!-- Live results content -->
      <div id="live-results-content" class="live-results-content">
        <div class="muted" style="text-align:center;padding:20px">No findings yet...</div>
      </div>
    </div>
    
    <div id="scan-summary" class="scan-summary"></div>
    
    <!-- Scan History -->
    <div id="scan-history" style="margin-top:16px;display:none">
      <h4 style="margin:0 0 12px">Scan History</h4>
      <div id="scan-history-list" class="scan-history-list">
        <!-- Scan history entries will be populated here -->
      </div>
    </div>
  </div>

  <style>
    .workflow-steps {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 16px 0;
      margin-bottom: 24px;
    }
    
    .step {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 200px;
      padding: 12px;
      border-radius: 8px;
      background: var(--bg2);
      border: 1px solid var(--card-b);
    }
    
    .step.completed {
      background: #ecfdf5;
      border-color: #10b981;
    }
    
    .step.active {
      background: #dbeafe;
      border-color: #3b82f6;
    }
    
    .step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--accent);
      color: #0b1020;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }
    
    .step.completed .step-number {
      background: #10b981;
    }
    
    .step.active .step-number {
      background: #3b82f6;
    }
    
    .step-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .step-description {
      font-size: 0.9rem;
      color: var(--muted);
    }
    
    .endpoint-summary {
      background: var(--bg2);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--card-b);
    }
    
    .severity-selector {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .severity-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--card-b);
      background: var(--bg2);
      transition: all 0.2s ease;
    }
    
    .severity-option:hover {
      background: var(--card);
      border-color: var(--accent);
    }
    
    .severity-option input[type="checkbox"] {
      margin: 0;
      accent-color: var(--accent);
    }
    
    .severity-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .severity-badge.critical { background: #fef2f2; color: #dc2626; }
    .severity-badge.high { background: #fef3c7; color: #d97706; }
    .severity-badge.medium { background: #dbeafe; color: #2563eb; }
    .severity-badge.low { background: #f0fdf4; color: #16a34a; }
    .severity-badge.info { background: #f8fafc; color: #64748b; }
    
    .template-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--card-b);
      border-radius: 8px;
      padding: 8px;
      background: var(--bg2);
    }
    
    .template-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      border-bottom: 1px solid var(--card-b);
    }
    
    .template-item:last-child {
      border-bottom: none;
    }
    
    .scan-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg2);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      text-align: center;
      font-size: 0.9rem;
      color: var(--muted);
    }
    
    .scan-summary {
      background: var(--bg2);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--card-b);
    }

    .scan-history-list {
      border: 1px solid var(--card-b);
      border-radius: 8px;
      background: var(--card);
      max-height: 300px;
      overflow-y: auto;
    }

    .scan-history-item {
      padding: 12px;
      border-bottom: 1px solid var(--bg2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .scan-history-item:last-child {
      border-bottom: none;
    }

    .scan-history-info {
      flex: 1;
    }

    .scan-history-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .scan-history-details {
      font-size: 12px;
      color: var(--muted);
    }

    .scan-history-actions {
      display: flex;
      gap: 8px;
    }

    .live-results-content {
      border: 1px solid var(--card-b);
      border-radius: 8px;
      background: var(--card);
      max-height: 300px;
      overflow-y: auto;
      padding: 12px;
      font-family: monospace;
      font-size: 12px;
      line-height: 1.4;
    }

    .live-result-item {
      padding: 8px;
      border-bottom: 1px solid var(--bg2);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .live-result-item:last-child {
      border-bottom: none;
    }

    .live-result-severity {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      min-width: 50px;
      text-align: center;
    }

    .live-result-severity.critical { background: #ef4444; color: white; }
    .live-result-severity.high { background: #f97316; color: white; }
    .live-result-severity.medium { background: #eab308; color: black; }
    .live-result-severity.low { background: #22c55e; color: white; }
    .live-result-severity.info { background: #3b82f6; color: white; }

    .live-result-details {
      flex: 1;
      min-width: 0;
    }

    .live-result-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .live-result-meta {
      color: var(--muted);
      font-size: 11px;
    }

    .live-result-time {
      color: var(--muted);
      font-size: 10px;
      white-space: nowrap;
    }

    .profile-list {
      border: 1px solid var(--card-b);
      border-radius: 8px;
      background: var(--card);
      max-height: 300px;
      overflow-y: auto;
    }

    .profile-item {
      padding: 12px;
      border-bottom: 1px solid var(--bg2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .profile-item:hover {
      background: var(--bg2);
    }

    .profile-item:last-child {
      border-bottom: none;
    }

    .profile-info {
      flex: 1;
    }

    .profile-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .profile-details {
      font-size: 12px;
      color: var(--muted);
    }

    .profile-actions {
      display: flex;
      gap: 8px;
    }

    .profile-manager-content {
      padding: 16px;
    }

    .selected-templates-list {
      border: 1px solid var(--card-b);
      border-radius: 8px;
      background: var(--card);
      max-height: 120px;
      overflow-y: auto;
      padding: 8px;
    }

    .selected-template-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      margin-bottom: 4px;
      background: var(--bg2);
      border-radius: 4px;
      font-size: 12px;
    }

    .selected-template-item:last-child {
      margin-bottom: 0;
    }

    .selected-template-name {
      flex: 1;
      font-weight: 600;
    }

    .selected-template-id {
      color: var(--muted);
      font-family: monospace;
    }

    .selected-template-remove {
      color: var(--err);
      cursor: pointer;
      font-weight: bold;
      padding: 2px 4px;
      border-radius: 2px;
      transition: background-color 0.2s ease;
    }

    .selected-template-remove:hover {
      background: var(--err);
      color: white;
    }
    
    .stat-card {
      background: var(--card);
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--card-b);
      text-align: center;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .stat-number {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 6px;
      line-height: 1.2;
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
      line-height: 1.2;
    }
    
    .endpoint-summary {
      background: var(--bg2);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--card-b);
      margin-bottom: 16px;
    }
    
    .template-count {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 8px;
    }
    
    .scan-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--card-b);
    }
    
    .scan-actions .btn {
      min-width: 120px;
    }
  </style>

  <script>
    // Active Testing JavaScript
    let nucleiStatus = null;
    let availableTemplates = [];
    let scanInProgress = false;
    
    // SSE Panel State (Phase 4A enhanced)
    let sseConnection = null;
    let sseReconnectAttempts = 0;
    let sseMaxReconnectAttempts = 5;
    let sseReconnectDelays = [1000, 2000, 5000, 5000, 5000]; // Progressive backoff
    let sseLastHeartbeat = null;
    let sseHeartbeatTimeout = 30000; // 30 seconds
    let ssePaused = false;
    let sseAutoScroll = true;
    let sseStartTime = null;
    let sseStats = {
      findings: 0,
      endpoints: 0,
      duration: 0
    };

    // SSE Connection Management (Phase 4A enhanced)
    function connectSSE(url) {
      if (sseConnection) {
        sseConnection.close();
      }
      
      sseConnection = new EventSource(url);
      sseStartTime = Date.now();
      sseLastHeartbeat = Date.now();
      sseReconnectAttempts = 0;
      
      // Hide error banner on successful connection
      hideSSEError();
      
      sseConnection.onopen = function(event) {
        console.log('[SSE] Connected to stream');
        updateLiveIndicator('connected');
        
        // Hide reconnecting ribbon on successful connection
        const reconnectingRibbon = document.getElementById('reconnecting-ribbon');
        if (reconnectingRibbon) {
          reconnectingRibbon.style.display = 'none';
        }
      };
      
      sseConnection.onmessage = function(event) {
        if (!ssePaused) {
          handleSSEMessage(event);
        }
      };
      
      sseConnection.addEventListener('start', function(event) {
        const data = JSON.parse(event.data || '{}');
        sseStats.endpoints = data.total_endpoints || 0;
        sseStats.processed = 0;
        sseStats.findings = 0;
        
        // Show run details link
        const runLink = document.getElementById('run-link');
        const runDetailsLink = document.getElementById('run-details-link');
        if (runLink && runDetailsLink && data.run_id) {
          runLink.href = `/p/{{ pid }}/runs?highlight=${data.run_id}`;
          runDetailsLink.style.display = 'block';
        }
        
        // Show "Now scanning" section
        const nowScanning = document.getElementById('now-scanning');
        if (nowScanning) {
          nowScanning.style.display = 'block';
        }
        
        updateLiveCounters();
        console.log('[SSE] Scan started:', data);
      });
      
      sseConnection.addEventListener('progress', function(event) {
        const data = JSON.parse(event.data || '{}');
        sseStats.processed = data.processed || 0;
        
        // Update current endpoint and template display
        const currentEndpoint = document.getElementById('current-endpoint');
        const currentTemplate = document.getElementById('current-template');
        if (currentEndpoint && data.endpoint) {
          const method = data.endpoint.method || 'GET';
          const path = data.endpoint.path || '';
          currentEndpoint.textContent = `${method} ${path}`;
        }
        if (currentTemplate && data.template_id) {
          currentTemplate.textContent = `(${data.template_id})`;
        }
        
        updateScanProgress(data);
        updateLiveCounters();
      });
      
      sseConnection.addEventListener('finding', function(event) {
        if (!ssePaused) {
          const data = JSON.parse(event.data || '{}');
          
          // Only increment counters for stored findings
          if (data.stored === true) {
            sseStats.findings++;
            addLiveFinding(data);
            updateLiveCounters();
          }
          
          // Dispatch custom event for UI integration
          dispatchCustomEvent('sse:message', {
            event: 'finding',
            data: data
          });
        }
      });
      
      sseConnection.addEventListener('heartbeat', function(event) {
        sseLastHeartbeat = Date.now();
        updateLiveIndicator('connected');
        console.log('[SSE] Heartbeat received');
      });
      
      sseConnection.addEventListener('done', function(event) {
        const data = JSON.parse(event.data || '{}');
        console.log('[SSE] Scan completed:', data);
        
        // Update final stats
        sseStats.processed = data.endpoints_processed || sseStats.processed;
        sseStats.findings = data.findings || sseStats.findings;
        
        // Hide "Now scanning" section
        const nowScanning = document.getElementById('now-scanning');
        if (nowScanning) {
          nowScanning.style.display = 'none';
        }
        
        updateLiveIndicator('completed');
        updateLiveCounters();
        sseConnection.close();
        sseConnection = null;
      });
      
      sseConnection.onerror = function(event) {
        console.error('[SSE] Connection error:', event);
        updateLiveIndicator('error');
        showSSEError('Connection lost. Attempting to reconnect...');
        
        // Show reconnecting ribbon
        const reconnectingRibbon = document.getElementById('reconnecting-ribbon');
        if (reconnectingRibbon) {
          reconnectingRibbon.style.display = 'block';
        }
        
        // Attempt reconnection with backoff
        if (sseReconnectAttempts < sseMaxReconnectAttempts) {
          const delay = sseReconnectDelays[sseReconnectAttempts] || 5000;
          setTimeout(() => {
            sseReconnectAttempts++;
            console.log(`[SSE] Reconnecting (attempt ${sseReconnectAttempts}/${sseMaxReconnectAttempts})`);
            connectSSE(url);
          }, delay);
        } else {
          showSSEError('Connection failed after multiple attempts. Please refresh the page.');
          // Hide reconnecting ribbon after max attempts
          if (reconnectingRibbon) {
            reconnectingRibbon.style.display = 'none';
          }
        }
      };
      
      // Heartbeat timeout check
      setInterval(() => {
        if (sseConnection && sseLastHeartbeat && (Date.now() - sseLastHeartbeat) > sseHeartbeatTimeout) {
          console.warn('[SSE] Heartbeat timeout');
          updateLiveIndicator('timeout');
          showSSEError('Connection timeout. Attempting to reconnect...');
          sseConnection.close();
        }
      }, 5000);
    }
    
    function handleSSEMessage(event) {
      // Handle generic messages
      console.log('[SSE] Message:', event.data);
    }
    
    function updateLiveIndicator(status) {
      const indicator = document.getElementById('live-indicator');
      if (!indicator) return;
      
      const statusClasses = {
        'connected': 'fas fa-circle',
        'error': 'fas fa-exclamation-triangle',
        'timeout': 'fas fa-clock',
        'completed': 'fas fa-check-circle'
      };
      
      const statusColors = {
        'connected': 'var(--ok)',
        'error': 'var(--err)',
        'timeout': 'var(--warn)',
        'completed': 'var(--ok)'
      };
      
      indicator.className = statusClasses[status] || 'fas fa-circle';
      indicator.style.color = statusColors[status] || 'var(--muted)';
    }
    
    function showSSEError(message) {
      const banner = document.getElementById('sse-error-banner');
      const messageEl = document.getElementById('sse-error-message');
      if (banner && messageEl) {
        messageEl.textContent = message;
        banner.style.display = 'block';
      }
    }
    
    function hideSSEError() {
      const banner = document.getElementById('sse-error-banner');
      if (banner) {
        banner.style.display = 'none';
      }
    }
    
    function updateLiveCounters() {
      const counters = document.getElementById('live-counters');
      if (!counters) return;
      
      // Update duration
      if (sseStartTime) {
        const duration = Math.floor((Date.now() - sseStartTime) / 1000);
        const hours = Math.floor(duration / 3600);
        const minutes = Math.floor((duration % 3600) / 60);
        const seconds = duration % 60;
        sseStats.duration = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
      
      counters.innerHTML = `
        <span class="chip" style="background:var(--ok);color:white;font-size:12px;font-weight:600">Findings: ${sseStats.findings}</span>
        <span class="chip" style="background:var(--accent);color:var(--bg);font-size:12px;font-weight:600">Endpoints: ${sseStats.processed}/${sseStats.endpoints}</span>
        <span class="chip" style="background:var(--muted);color:white;font-size:12px;font-weight:600">Duration: ${sseStats.duration}</span>
      `;
    }
    
    function addLiveFinding(finding) {
      const liveResultsContent = document.getElementById('live-results-content');
      if (!liveResultsContent) return;
      
      // Clear placeholder message
      const noMsg = liveResultsContent.querySelector('.muted');
      if (noMsg && noMsg.textContent.includes('No findings yet')) {
        noMsg.remove();
      }
      
      // Create finding row
      const item = document.createElement('div');
      item.className = 'live-result-item';
      item.innerHTML = `
        <div class="live-result-time">${new Date().toLocaleTimeString()}</div>
        <div class="live-result-severity ${finding.severity || 'info'}">${(finding.severity || 'info').toUpperCase()}</div>
        <div class="live-result-details">
          <div class="live-result-title">${finding.title || 'Finding'}</div>
          <div class="live-result-meta">${finding.endpoint_key || ''} • ${finding.detector_id || 'unknown'}</div>
        </div>
        <div class="live-result-counter">+1</div>
      `;
      
      // Add to top of results
      liveResultsContent.insertBefore(item, liveResultsContent.firstChild);
      
        // Keep only latest 50 findings
        const findingItems = liveResultsContent.querySelectorAll('.live-result-item');
        if (findingItems.length > 50) {
          for (let i = 50; i < findingItems.length; i++) {
            findingItems[i].remove();
          }
        }
      
      // Auto-scroll if enabled
      if (sseAutoScroll) {
        liveResultsContent.scrollTop = 0;
      }
      
        // Keep only last 50 results
        const resultItems = liveResultsContent.querySelectorAll('.live-result-item');
        if (resultItems.length > 50) {
          resultItems[resultItems.length - 1].remove();
        }
    }
    
    function togglePauseResume() {
      ssePaused = !ssePaused;
      const btn = document.getElementById('pause-resume-btn');
      if (btn) {
        if (ssePaused) {
          btn.innerHTML = '<i class="fas fa-play"></i> Resume';
          btn.setAttribute('aria-label', 'Resume live updates');
        } else {
          btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
          btn.setAttribute('aria-label', 'Pause live updates');
        }
      }
    }
    
    function toggleAutoScroll() {
      sseAutoScroll = !sseAutoScroll;
      const btn = document.getElementById('auto-scroll-btn');
      if (btn) {
        if (sseAutoScroll) {
          btn.innerHTML = '<i class="fas fa-arrow-down"></i> Auto-scroll';
          btn.style.background = 'var(--accent)';
          btn.style.color = 'var(--bg)';
        } else {
          btn.innerHTML = '<i class="fas fa-arrow-down"></i> Auto-scroll';
          btn.style.background = '';
          btn.style.color = '';
        }
      }
    }
    
    function dispatchCustomEvent(eventName, detail) {
      const event = new CustomEvent(eventName, { detail: detail });
      document.dispatchEvent(event);
    }

    function checkNucleiStatus() {
      document.getElementById('nuclei-status').innerHTML = 'Checking Nuclei status...';
      
      fetch(`/p/{{ pid }}/nuclei/status`)
        .then(response => response.json())
        .then(data => {
          nucleiStatus = data.status;
          if (data.success && data.status.available) {
            document.getElementById('nuclei-status').innerHTML = 
              `✅ Nuclei v${data.status.version} available (${data.status.template_count} templates)`;
            loadEndpointSummary();
          } else {
            document.getElementById('nuclei-status').innerHTML = 
              '❌ Nuclei not available. Please install Nuclei scanner.';
          }
        })
        .catch(error => {
          document.getElementById('nuclei-status').innerHTML = 
            '❌ Error checking Nuclei status: ' + error.message;
        });
    }

    function updateNucleiTemplates() {
      document.getElementById('nuclei-status').innerHTML = 'Updating templates...';
      
      fetch(`/p/{{ pid }}/nuclei/update-templates`, {method: 'POST'})
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('nuclei-status').innerHTML = '✅ ' + data.message;
            checkNucleiStatus();
          } else {
            document.getElementById('nuclei-status').innerHTML = '❌ ' + data.message;
          }
        })
        .catch(error => {
          document.getElementById('nuclei-status').innerHTML = 
            '❌ Error updating templates: ' + error.message;
        });
    }

    function loadEndpointSummary() {
      // Load endpoint summary from queue
      fetch(`/p/{{ pid }}/queue/summary`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const summary = document.getElementById('endpoint-summary');
            summary.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <strong>${data.endpoint_count} endpoints</strong> ready for scanning
                  <div class="muted" style="font-size:0.9rem;margin-top:4px">
                    ${data.methods.join(', ')} methods • ${data.specs_count} API specifications
                  </div>
                </div>
                <div class="chip" style="background:var(--accent);color:#0b1020">
                  Ready to Scan
                </div>
              </div>
            `;
            
            // Also update the endpoint count in the template selection section
            const endpointCountEl = document.getElementById('endpoint-count');
            if (endpointCountEl) {
              endpointCountEl.textContent = `${data.endpoint_count} endpoints`;
            }
          }
        })
        .catch(error => {
          document.getElementById('endpoint-summary').innerHTML = 
            '<div class="muted">Error loading endpoint summary</div>';
        });
    }

    function loadTemplates() {
      const category = document.getElementById('template-category').value;
      const templateList = document.getElementById('template-list');
      const templateCount = document.getElementById('template-count');
      
      templateList.innerHTML = 'Loading templates...';
      templateCount.innerHTML = '<span class="muted">Loading...</span>';
      
      const url = category ? `/p/{{ pid }}/nuclei/templates?category=${category}` : `/p/{{ pid }}/nuclei/templates`;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            availableTemplates = data.templates;
            templateList.innerHTML = '';
            
            data.templates.forEach(template => {
              const div = document.createElement('div');
              div.className = 'template-item';
              div.setAttribute('data-name', template.name);
              div.setAttribute('data-id', template.id);
              div.innerHTML = `
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;width:100%">
                  <input type="checkbox" name="templates" value="${template.id}">
                  <span style="font-size:0.9rem;flex:1">${template.name}</span>
                  <span class="muted" style="font-size:0.8rem">${template.id}</span>
                </label>
              `;
              templateList.appendChild(div);
            });
            
            templateCount.innerHTML = `<strong>${data.templates.length}</strong> templates available`;
          } else {
            templateList.innerHTML = '❌ Error loading templates: ' + data.error;
            templateCount.innerHTML = '<span class="muted">Error loading templates</span>';
          }
        })
        .catch(error => {
          templateList.innerHTML = '❌ Error loading templates: ' + error.message;
          templateCount.innerHTML = '<span class="muted">Error loading templates</span>';
        });
    }

    function runActiveScan() {
      if (scanInProgress) {
        showNotification('Scan already in progress', 'info');
        return;
      }
      
      // Determine selected template IDs from global TPL or sessionStorage fallback
      let selectedIds = new Set();
      try {
        if (typeof TPL !== 'undefined' && TPL.selected) {
          selectedIds = new Set(TPL.selected);
        } else {
          selectedIds = new Set(JSON.parse(sessionStorage.getItem('tpl_selected') || '[]'));
        }
      } catch(_) {}
      // Check selection
      if (!selectedIds || selectedIds.size === 0) {
        try { showNotification('Please select at least one template using "Quick Select" or "Advanced Manager"', 'error'); } catch(_) {}
        return;
      }
      
      const formData = new FormData();
      
      // Get selected severities
      const severities = Array.from(document.querySelectorAll('input[name="severity"]:checked'))
        .map(cb => cb.value);
      severities.forEach(s => formData.append('severity', s));
      
      // Get selected templates from the new template management system
      selectedIds.forEach(t => formData.append('templates', t));
      
      // Get advanced options
      const rateLimit = document.getElementById('rate-limit').value;
      const timeout = document.getElementById('timeout').value;
      formData.append('rate_limit', rateLimit);
      formData.append('timeout', timeout);
      
      // Show results section
      const resultsDiv = document.getElementById('scan-results');
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');
      const scanButton = document.getElementById('scan-button');
      const liveResultsDiv = document.getElementById('live-results');
      
      resultsDiv.style.display = 'block';
      liveResultsDiv.style.display = 'block';
      scanButton.disabled = true;
      scanButton.innerHTML = '🔄 Scanning...';
      scanInProgress = true;
      
      // Clear previous live results
      clearLiveResults();
      try { console.log('[ActiveScan] Selected templates:', Array.from(selectedIds)); } catch(_) {}
      // Reset live counters
      window.LIVE = { counts: { critical:0, high:0, medium:0, low:0, info:0 } };
      renderLiveCounters();
      
      // Show initial scan details
      const scanDetails = document.getElementById('scan-details');
      const endpointCountEl = document.getElementById('endpoint-count');
      const endpointCount = endpointCountEl ? endpointCountEl.textContent : '0 endpoints';
      if (scanDetails) {
        scanDetails.textContent = `Testing ${selectedIds.size} templates on ${endpointCount}`;
      }
      
      // Simulate progress but prefer SSE-driven updates when available
      let progress = 0;
      let templateIndex = 0;
      const templates = Array.from(selectedIds || []);
      const totalTemplates = templates.length;
      let sseTotal = 0;
      let sseCurrent = 0;
      
      const progressInterval = setInterval(() => {
        // If SSE is providing totals, derive progress from it
        if (sseTotal > 0) {
          const pct = Math.max(3, Math.min(95, Math.round(((sseCurrent - 1) / sseTotal) * 95)));
          progress = pct;
        } else {
          // Fallback: approximate progress
          if (progress < 20) progress += Math.random() * 3 + 1; else if (progress < 80) progress += Math.random() * 8 + 2; else progress += Math.random() * 2 + 0.5;
          if (progress > 95) progress = 95;
        }
        
        progressFill.style.width = progress + '%';
        progressText.textContent = `Scanning... ${Math.round(progress)}%`;
        
        // Update scan details with current template being tested
        if (templateIndex < totalTemplates) {
          const currentTemplate = templates[templateIndex];
          const templateName = TPL.all.find(t => t.id === currentTemplate)?.name || currentTemplate;
          if (scanDetails) {
            scanDetails.textContent = `Testing: ${templateName} on endpoints...`;
          }
          
          // Move to next template every few seconds
          if (Math.random() < 0.3) { // 30% chance to move to next template
            templateIndex++;
          }
        } else {
          // All templates processed, show final phase
          if (scanDetails) {
            scanDetails.textContent = `Finalizing scan results...`;
          }
        }
        
        // Note: Real findings will be added when the scan completes
        // We don't simulate fake findings during the scan
      }, 800); // Slightly faster updates for smoother progress
      
      // Start robust SSE stream for live updates (Phase 4A enhanced)
      try {
        const qs = new URLSearchParams();
        // Generate a run_id shared with the POST call so both stay in sync
        const runId = `run_${Date.now()}`;
        window.__NUCLEI_RUN_ID__ = runId;
        try { sessionStorage.setItem('active_nuclei_run', '1'); sessionStorage.setItem('active_nuclei_run_id', runId); } catch(_) {}
        qs.append('run_id', runId);
        Array.from(document.querySelectorAll('input[name="severity"]:checked')).forEach(cb => qs.append('severity', cb.value));
        selectedIds.forEach(t => qs.append('templates', t));
        const url = `/p/{{ pid }}/nuclei/stream?${qs.toString()}`;
        try { console.log('[ActiveScan] Connecting robust SSE', url); } catch(_) {}
        
        // Use the new robust SSE connection
        connectSSE(url);
        
      } catch (err) { 
        console.error('[ActiveScan] SSE setup error:', err);
      }

      fetch(`/p/{{ pid }}/nuclei/scan`, {
        method: 'POST',
        body: (function(){ const fd = formData; if (window.__NUCLEI_RUN_ID__) fd.append('run_id', window.__NUCLEI_RUN_ID__); return fd; })()
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        progressText.textContent = 'Scan completed';
        if (scanDetails) {
          const actualFindings = data.findings_count || 0;
          const actualEndpoints = data.endpoints_tested || data.endpoints_scanned || 0;
          scanDetails.textContent = `Completed: ${actualFindings} findings found across ${actualEndpoints} endpoints`;
        }
        
        console.log('Scan response:', data); // Debug log
        
        if (data.success) {
          // Add to scan history and mark run finished for persistence handling
          addScanToHistory(data);
          try { sessionStorage.removeItem('active_nuclei_run'); sessionStorage.removeItem('active_nuclei_run_id'); } catch {}
          
          // Update live results with final count
          const liveResultsContent = document.getElementById('live-results-content');
          if (liveResultsContent) {
            const actualFindings = data.findings_count || 0;
            const actualEndpoints = data.endpoints_tested || data.endpoints_scanned || 0;
            
            const summaryItem = document.createElement('div');
            summaryItem.className = 'live-result-item';
            summaryItem.style.borderTop = '2px solid var(--accent)';
            summaryItem.innerHTML = `
              <div class="live-result-severity info">DONE</div>
              <div class="live-result-details">
                <div class="live-result-title">Scan Completed</div>
                <div class="live-result-meta">Found ${actualFindings} vulnerabilities across ${actualEndpoints} endpoints</div>
              </div>
              <div class="live-result-time">${new Date().toLocaleTimeString()}</div>
            `;
            liveResultsContent.insertBefore(summaryItem, liveResultsContent.firstChild);
          }
          
          const rid = window.__NUCLEI_RUN_ID__;
          document.getElementById('scan-summary').innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px">
              <div class="stat-card">
                <div class="stat-number">${data.endpoints_scanned || 0}</div>
                <div class="stat-label">Endpoints Scanned</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${data.findings_count || 0}</div>
                <div class="stat-label">Vulnerabilities Found</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${selectedIds.size}</div>
                <div class="stat-label">Templates Used</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${getSelectedSeverities().length}</div>
                <div class="stat-label">Severity Filter</div>
              </div>
            </div>
            <div style=\"text-align:center;margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap\">
              <a href=\"{{ url_for('web.findings_page', pid=pid) }}\" class=\"btn primary\">View Findings</a>
              <button class=\"btn ghost\" onclick=\"runActiveScan()\">Run Another Scan</button>
              <button class=\"btn\" onclick=\"viewScanDetails()\">View Run Details</button>
              <button class=\"btn ghost\" onclick=\"exportScanResults()\">Export</button>
            </div>
          `;
        } else {
          document.getElementById('scan-summary').innerHTML = `
            <div style="color:#ef4444;text-align:center;padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px">
              <div style="font-weight:600;margin-bottom:8px">❌ Scan Failed</div>
              <div>${data.error || data.message || 'Unknown error occurred'}</div>
            </div>
          `;
        }
      })
      .catch(error => {
        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        progressText.textContent = 'Scan failed';
        if (scanDetails) {
          scanDetails.textContent = '';
        }
        
        console.error('Scan error:', error); // Debug log
        try { sessionStorage.removeItem('active_nuclei_run'); sessionStorage.removeItem('active_nuclei_run_id'); } catch {}
        
        document.getElementById('scan-summary').innerHTML = `
          <div style="color:#ef4444;text-align:center;padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px">
            <div style="font-weight:600;margin-bottom:8px">❌ Network Error</div>
            <div>${error.message}</div>
            <div style="margin-top:12px">
              <button class="btn ghost" onclick="runActiveScan()">Try Again</button>
            </div>
          </div>
        `;
      })
      .finally(() => {
        scanButton.disabled = false;
        scanButton.innerHTML = '🚀 Run Active Scan';
        scanInProgress = false;
      });
    }

    // Expose handler globally and attach defensively
    try {
      window.runActiveScan = runActiveScan;
      document.addEventListener('DOMContentLoaded', function(){
        const btn = document.getElementById('scan-button');
        if (btn && !btn.__scanBound) {
          btn.addEventListener('click', function(ev){ ev.preventDefault(); runActiveScan(); });
          btn.__scanBound = true;
        }
      });
    } catch(_) {}

    function addScanToHistory(scanData) {
      const historyDiv = document.getElementById('scan-history');
      const historyList = document.getElementById('scan-history-list');
      
      historyDiv.style.display = 'block';
      
      const scanEntry = document.createElement('div');
      scanEntry.className = 'scan-history-item';
      const tplFromSession = (() => { try { return JSON.parse(sessionStorage.getItem('tpl_selected')||'[]').length || 0; } catch(_) { return 0; } })();
      const tplCount = scanData.templates_used || tplFromSession;
      scanEntry.innerHTML = `
        <div class="scan-history-info">
          <div class="scan-history-title">Scan ${new Date().toLocaleString()}</div>
        <div class="scan-history-details">
          ${tplCount} templates • 
          ${scanData.endpoints_tested || scanData.endpoints_scanned || 0} endpoints • 
          ${scanData.findings_count || 0} findings
        </div>
        </div>
        <div class="scan-history-actions">
          <button class="btn ghost" onclick="viewScanDetails('${Date.now()}')">View Details</button>
          <button class="btn ghost" onclick="exportScanResults('${Date.now()}')">Export</button>
        </div>
      `;
      
      historyList.insertBefore(scanEntry, historyList.firstChild);
    }

    function viewScanDetails(scanId) {
      try {
        const rid = window.__NUCLEI_RUN_ID__ || scanId;
        if (!rid) { showNotification('No run available yet', 'error'); return; }
        htmx.ajax('POST', '/p/{{ pid }}/runs/detail-latest', { target:'#panel-body', swap:'innerHTML', values:{ run_id: rid } });
        try { openPanelWith('Run details'); } catch(_) {}
      } catch (e) { try { showNotification('Open details failed: '+e.message, 'error'); } catch(_) {} }
    }

    function exportScanResults(scanId) {
      try {
        const rid = window.__NUCLEI_RUN_ID__ || scanId;
        if (!rid) { showNotification('No run available yet', 'error'); return; }
        window.open(`/p/{{ pid }}/runs/export?run_id=${encodeURIComponent(rid)}`, '_blank');
      } catch (e) { try { showNotification('Export failed: '+e.message, 'error'); } catch(_) {} }
    }

    function addLiveResult(finding) {
      const liveResultsContent = document.getElementById('live-results-content');
      if (!liveResultsContent) return;
      
      // Clear the "No findings yet..." message if it exists
      const noFindingsMsg = liveResultsContent.querySelector('.muted');
      if (noFindingsMsg && noFindingsMsg.textContent.includes('No findings yet')) {
        noFindingsMsg.remove();
      }
      
      const resultItem = document.createElement('div');
      resultItem.className = 'live-result-item';
      resultItem.innerHTML = `
        <div class="live-result-severity ${finding.severity || 'info'}">${(finding.severity || 'info').toUpperCase()}</div>
        <div class="live-result-details">
          <div class="live-result-title">${finding.title || finding.name || 'Security Finding'}</div>
          <div class="live-result-meta">${finding.method || 'GET'} ${finding.path || finding.url || 'Unknown'} • ${finding.template_id || 'Unknown Template'}</div>
        </div>
        <div class="live-result-time">${new Date().toLocaleTimeString()}</div>
      `;
      
      // Add to top of results
      liveResultsContent.insertBefore(resultItem, liveResultsContent.firstChild);
      
        // Keep only last 20 results to prevent memory issues
        const progressItems = liveResultsContent.querySelectorAll('.live-result-item');
        if (progressItems.length > 20) {
          progressItems[progressItems.length - 1].remove();
        }
      
      // Auto-scroll to show new results
      liveResultsContent.scrollTop = 0;
    }

    function clearLiveResults() {
      const liveResultsContent = document.getElementById('live-results-content');
      if (liveResultsContent) {
        liveResultsContent.innerHTML = '<div class="muted" style="text-align:center;padding:20px">No findings yet...</div>';
      }
      
      // Reset SSE stats
      sseStats.findings = 0;
      sseStats.endpoints = 0;
      sseStats.duration = '00:00:00';
      sseStartTime = null;
      updateLiveCounters();
      
      // Clear old live counters if they exist
      const lc = document.getElementById('live-counters');
      if (lc) {
        lc.innerHTML = `
          <span class="chip" style="background:var(--ok);color:white;font-size:12px;font-weight:600">Findings: 0</span>
          <span class="chip" style="background:var(--accent);color:var(--bg);font-size:12px;font-weight:600">Endpoints: 0</span>
          <span class="chip" style="background:var(--muted);color:white;font-size:12px;font-weight:600">Duration: 00:00:00</span>
        `;
      }
    }

    function toggleLiveResults() {
      const liveResultsContent = document.getElementById('live-results-content');
      if (!liveResultsContent) return;
      liveResultsContent.style.display = (liveResultsContent.style.display === 'none') ? 'block' : 'none';
    }

    // Render live severity counters
    function renderLiveCounters(){
      const lc = document.getElementById('live-counters');
      if (!lc || !window.LIVE) return;
      const c = window.LIVE.counts || { critical:0, high:0, medium:0, low:0, info:0 };
      lc.innerHTML = `
        <span class="pill" style="background:var(--err-bg);color:var(--err)">critical: ${c.critical||0}</span>
        <span class="pill" style="background:rgba(244,114,182,.15);color:#f472b6">high: ${c.high||0}</span>
        <span class="pill" style="background:rgba(234,179,8,.15);color:#eab308">medium: ${c.medium||0}</span>
        <span class="pill" style="background:rgba(34,197,94,.15);color:#22c55e">low: ${c.low||0}</span>
        <span class="pill" style="background:rgba(59,130,246,.15);color:#60a5fa">info: ${c.info||0}</span>
      `;
    }

    function clearScanConfig() {
      document.querySelectorAll('input[name="severity"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('input[name="templates"]').forEach(cb => cb.checked = false);
      document.getElementById('template-category').value = '';
      document.getElementById('template-list').innerHTML = '<div class="muted">Select a category to load templates...</div>';
      document.getElementById('template-count').innerHTML = '<span class="muted">Select a category to see available templates</span>';
    }

    function saveScanProfile() {
      // TODO: Implement scan profile saving
      showNotification('Scan profile saving not yet implemented', 'info');
    }

    function getSelectedSeverities() {
      const selectedSeverities = [];
      document.querySelectorAll('input[name="severity"]:checked').forEach(checkbox => {
        selectedSeverities.push(checkbox.value);
      });
      return selectedSeverities;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      checkNucleiStatus();
      
      // Load template catalog first, then update display
      if (window.loadTemplatesCatalog) {
        loadTemplatesCatalog().then(() => {
          // Initialize selected templates display after catalog is loaded
          if (window.updateSelectedTemplatesDisplay) {
            updateSelectedTemplatesDisplay();
          }
        });
      } else {
        // Fallback: just update display if catalog loading isn't available
        if (window.updateSelectedTemplatesDisplay) {
          updateSelectedTemplatesDisplay();
        }
      }
      
      // Debug: Check if template management elements exist
      console.log('Template management elements:', {
        sidepanel: !!document.getElementById('tpl-sidepanel'),
        modal: !!document.getElementById('tpl-manager-modal'),
        functions: {
          openTemplateSidePanel: typeof openTemplateSidePanel,
          openTemplateManagerModal: typeof openTemplateManagerModal
        }
      });

      // Resume live stream if a scan is active
      try {
        const active = sessionStorage.getItem('active_nuclei_run');
        if (active === '1' && !window.__NUCLEI_RUN_ID__) {
          // Attempt to reconnect with last known run_id if present
          const last = sessionStorage.getItem('active_nuclei_run_id');
          const qs = new URLSearchParams();
          if (last) qs.append('run_id', last);
          const es = new EventSource(`/p/{{ pid }}/nuclei/stream?${qs.toString()}`);
          es.addEventListener('done', () => { try{ es.close(); sessionStorage.removeItem('active_nuclei_run'); sessionStorage.removeItem('active_nuclei_run_id'); }catch{} });
        }
      } catch(_) {}
    });

    // Template management functions (ensure they're available)
    function openTemplateSidePanel(){
      console.log('openTemplateSidePanel called');
      const panel = document.getElementById('tpl-sidepanel');
      if (!panel) {
        console.error('tpl-sidepanel element not found');
        return;
      }
      panel.classList.add('open');
      if (!window.TPL || !window.TPL.all.length) {
        if (window.loadTemplatesCatalog) window.loadTemplatesCatalog();
        else console.error('loadTemplatesCatalog not available');
      } else {
        if (window.renderSidePanel) window.renderSidePanel();
        else console.error('renderSidePanel not available');
      }
    }

    function openTemplateManagerModal(){
      console.log('openTemplateManagerModal called');
      const modal = document.getElementById('tpl-manager-modal');
      if (!modal) {
        console.error('tpl-manager-modal element not found');
        return;
      }
      modal.classList.add('open');
      if (!window.TPL || !window.TPL.all.length) {
        if (window.loadTemplatesCatalog) {
          window.loadTemplatesCatalog().then(()=>{ 
            if (window.loadTemplateCategories) window.loadTemplateCategories(); 
            if (window.renderTemplateTable) window.renderTemplateTable(); 
            if (window.loadProfiles) window.loadProfiles(); 
          });
        } else console.error('loadTemplatesCatalog not available');
      } else {
        if (window.loadTemplateCategories) window.loadTemplateCategories();
        if (window.renderTemplateTable) window.renderTemplateTable();
        if (window.loadProfiles) window.loadProfiles();
      }
    }

    function openTemplateManager(){
      // Open the new template manager page
      window.open(`/p/${window.currentProjectId}/templates/manager`, '_blank');
    }
  </script>

  <!-- Quick Selection Side Panel -->
  <aside id="tpl-sidepanel" class="drawer drawer-right" aria-hidden="true">
    <div class="drawer-head">
      <h3 style="margin:0">Template Selection</h3>
      <button class="btn ghost" onclick="closeTemplateSidePanel()">Close</button>
    </div>

    <div class="drawer-body">
      <div class="row" style="gap:8px;margin-bottom:12px">
        <input id="tpl-search" type="text" placeholder="Search templates (name, id, CVE)…" oninput="filterSidePanelTemplates()" style="flex:1">
        <button class="btn ghost" onclick="selectAllVisibleTemplates()">Select All</button>
          <button class="btn ghost" onclick="deselectAllVisibleTemplates()">Deselect</button>
          <button class="btn ghost" onclick="clearAllSelectedTemplates()">Clear All</button>
      </div>

      <div class="row" style="gap:6px;flex-wrap:wrap;margin-bottom:8px">
        <span class="tag" data-cat="cve" onclick="toggleTplCategory(this)">CVE (3,301)</span>
        <span class="tag" data-cat="exposure" onclick="toggleTplCategory(this)">Exposure (1,307)</span>
        <span class="tag" data-cat="vulnerabilities" onclick="toggleTplCategory(this)">Vulnerabilities (962)</span>
        <span class="tag" data-cat="technologies" onclick="toggleTplCategory(this)">Technologies (771)</span>
        <span class="tag" data-cat="misconfiguration" onclick="toggleTplCategory(this)">Misconfig (707)</span>
        <span class="tag" data-cat="default-logins" onclick="toggleTplCategory(this)">Default Logins (259)</span>
        <span class="tag" data-cat="detection" onclick="toggleTplCategory(this)">Detection (151)</span>
        <span class="tag" data-cat="recent" onclick="toggleTplCategory(this)">Recent</span>
      </div>

      <div class="sidepanel-content">
        <div id="tpl-sidepanel-list" class="virtual-list">
          <!-- populated by loadSidePanelTemplates() -->
        </div>
      </div>

      <div class="sidepanel-footer">
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <div class="muted"><span id="tpl-sidepanel-count">0</span> shown of <span id="tpl-total-count">8,560</span> total</div>
        </div>
          <div class="row" style="gap:8px">
            <button class="btn ghost" onclick="openSaveProfile()" style="flex:1">Save Profile</button>
            <button class="btn ghost" onclick="openProfileSelection()" style="flex:1">Load Profile</button>
            <button class="btn ghost" onclick="openProfileManager()" style="flex:1">Manage Profiles</button>
          </div>
      </div>
    </div>
  </aside>

  <!-- Full Manager Modal -->
  <div id="tpl-manager-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-head">
        <h3 style="margin:0">Template Manager</h3>
        <button class="btn ghost" onclick="closeTemplateManagerModal()">Close</button>
      </div>

      <div class="grid" style="grid-template-columns: 220px 1fr; gap:16px">
        <!-- Left: categories & profiles -->
        <div>
          <div class="card" style="margin-bottom:12px">
            <div class="muted" style="margin-bottom:6px">Categories</div>
            <div id="tpl-cats" class="col tags-vertical">
              <!-- filled by loadTemplateCategories() -->
            </div>
          </div>
          <div class="card">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="muted">Profiles</div>
              <button class="btn ghost" onclick="openProfileManager()">Manage</button>
            </div>
            <div id="tpl-profiles" class="list small">
              <!-- filled by loadProfiles() -->
            </div>
          </div>
        </div>

        <!-- Right: templates table -->
        <div>
          <div class="row" style="gap:8px;margin-bottom:8px">
            <input id="tpl-modal-search" type="text" placeholder="Search name/id/desc…" oninput="refreshTemplateTable()"
                   style="flex:1">
            <button class="btn ghost" onclick="selectAllInTable()">Select all</button>
            <button class="btn ghost" onclick="deselectAllInTable()">Deselect all</button>
            <button class="btn ghost" onclick="clearAllSelectedTemplates()">Clear All</button>
          </div>

          <div class="table-wrap">
            <table class="tight">
              <thead>
                <tr><th style="width:34px"></th><th>Name</th><th>ID</th><th>Tags</th><th>Severity</th></tr>
              </thead>
              <tbody id="tpl-table-body">
                <!-- paged rows -->
              </tbody>
            </table>
          </div>

          <div class="row" style="justify-content:space-between;margin-top:8px">
            <div class="muted">Selected: <span id="tpl-selected-count">0</span></div>
            <div class="pagination">
              <button class="btn ghost" onclick="prevTplPage()">Prev</button>
              <span id="tpl-page-indicator" class="muted">1/1</span>
              <button class="btn ghost" onclick="nextTplPage()">Next</button>
            </div>
          </div>
        </div>
      </div>

        <div class="modal-foot">
          <button class="btn primary" onclick="applyTemplateSelection()">Apply Selection</button>
          <button class="btn ghost" onclick="closeTemplateManagerModal()">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Simple Profile Selection Modal -->
    <div id="profile-selection-modal" class="modal" aria-hidden="true">
      <div class="modal-content" style="width: min(500px, 90vw)">
        <div class="modal-head">
          <h3 style="margin:0">Load Profile</h3>
          <button class="btn ghost" onclick="closeProfileSelection()">Close</button>
        </div>

        <div class="profile-selection-content">
          <div class="card">
            <h4 style="margin:0 0 12px">Select a Profile to Load</h4>
            <div id="profile-selection-list" class="profile-list">
              <!-- Profiles will be populated here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Save Profile Modal -->
    <div id="save-profile-modal" class="modal" aria-hidden="true">
      <div class="modal-content" style="width: min(600px, 90vw)">
        <div class="modal-head">
          <h3 style="margin:0">Save Profile</h3>
          <button class="btn ghost" onclick="closeSaveProfile()">Close</button>
        </div>

        <div class="save-profile-content">
          <div class="card" style="margin-bottom:16px">
            <h4 style="margin:0 0 12px">Save Current Selection</h4>
            <div class="row" style="gap:8px;margin-bottom:12px">
              <input id="save-profile-name" type="text" placeholder="Enter profile name..." style="flex:1">
              <button class="btn primary" onclick="saveCurrentSelectionAsProfile()">Save New Profile</button>
            </div>
            <div class="muted" style="font-size:12px;margin-bottom:8px">
              <strong id="save-profile-count">0</strong> templates selected
            </div>
          </div>

          <div class="card">
            <h4 style="margin:0 0 12px">Update Existing Profile</h4>
            <div class="row" style="gap:8px;margin-bottom:8px">
              <select id="existing-profile-select" style="flex:1" onchange="loadExistingProfileForUpdate()">
                <option value="">Select profile to update...</option>
              </select>
              <button class="btn ghost" onclick="updateExistingProfile()" id="update-profile-btn" disabled>Update Profile</button>
            </div>
            <div class="row" style="gap:8px">
              <label style="display:flex;align-items:center;gap:4px;font-size:12px">
                <input type="radio" name="update-mode" value="replace" checked>
                Replace all templates
              </label>
              <label style="display:flex;align-items:center;gap:4px;font-size:12px">
                <input type="radio" name="update-mode" value="append">
                Add to existing templates
              </label>
            </div>
            <div id="existing-profile-info" class="muted" style="font-size:12px;margin-top:8px;display:none">
              <!-- Profile info will be shown here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Manager Modal -->
    <div id="profile-manager-modal" class="modal" aria-hidden="true">
      <div class="modal-content" style="width: min(600px, 90vw)">
        <div class="modal-head">
          <h3 style="margin:0">Profile Manager</h3>
          <button class="btn ghost" onclick="closeProfileManager()">Close</button>
        </div>

        <div class="profile-manager-content">
          <!-- Save New Profile -->
          <div class="card" style="margin-bottom:16px">
            <h4 style="margin:0 0 12px">Save Current Selection</h4>
            <div class="row" style="gap:8px">
              <input id="manager-profile-name" type="text" placeholder="Enter profile name..." style="flex:1">
              <button class="btn primary" onclick="saveProfileFromManager()">Save Profile</button>
            </div>
            <div class="muted" style="font-size:12px;margin-top:8px">
              <strong id="manager-profile-count">0</strong> templates selected
            </div>
          </div>

          <!-- Load Existing Profiles -->
          <div class="card">
            <h4 style="margin:0 0 12px">Manage Profiles</h4>
            <div id="profile-list" class="profile-list">
              <!-- Profiles will be populated here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="modal" aria-hidden="true">
      <div class="modal-content" style="width: min(400px, 90vw)">
        <div class="modal-head">
          <h3 style="margin:0">Confirm Delete</h3>
        </div>

        <div class="delete-confirmation-content">
          <div class="card">
            <p style="margin:0 0 16px;color:var(--fg)">
              Are you sure you want to delete the profile 
              <strong id="delete-profile-name">Profile Name</strong>?
            </p>
            <p class="muted" style="margin:0 0 16px;font-size:12px">
              This action cannot be undone.
            </p>
            <div class="row" style="gap:8px;justify-content:flex-end">
              <button class="btn ghost" onclick="closeDeleteConfirmation()">Cancel</button>
              <button class="btn" onclick="confirmDeleteProfile()" style="background:var(--err);color:white">Delete Profile</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Clear Templates Confirmation Modal -->
    <div id="clear-templates-modal" class="modal" aria-hidden="true">
      <div class="modal-content" style="width: min(400px, 90vw)">
        <div class="modal-head">
          <h3 style="margin:0">Clear Templates</h3>
        </div>

        <div class="clear-templates-content">
          <div class="card">
            <p style="margin:0 0 16px;color:var(--fg)">
              Are you sure you want to clear all 
              <strong id="clear-templates-count">0</strong> selected templates?
            </p>
            <p class="muted" style="margin:0 0 16px;font-size:12px">
              This will deselect all currently selected templates.
            </p>
            <div class="row" style="gap:8px;justify-content:flex-end">
              <button class="btn ghost" onclick="closeClearTemplatesConfirmation()">Cancel</button>
              <button class="btn" onclick="confirmClearTemplates()" style="background:var(--accent);color:var(--bg)">Clear All</button>
            </div>
          </div>
        </div>
      </div>
    </div>
{% endblock %}

