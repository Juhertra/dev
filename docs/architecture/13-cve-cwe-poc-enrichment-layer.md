---
title: "SecFlow â€” CVE/CWE/POC Enrichment Layer"
author: "Hernan Trajtemberg, Lead Security Engineer"
codename: "SecFlow"
version: "1.0"
date: "2025-10-06"
---

# 13 â€” CVE/CWE/POC Enrichment Layer

## ðŸ§­ Overview

The **Enrichment Layer** bridges the gap between raw scanner results and full vulnerability intelligence.  
It performs automated correlation between findings and vulnerability databases such as:

- **CVE/NVD** â€” canonical vulnerability records  
- **CWE** â€” weakness categorization  
- **CVSS** â€” scoring and severity models  
- **Exploit-DB**, **Vulners**, **Metasploit**, **OSV** â€” PoC and exploit references  
- **MITRE ATT&CK** â€” behavioral mapping  

SecFlow treats enrichment as a **pluggable knowledge graph** layer that can be extended via simple JSON/YAML definitions or API connectors.

---

## âš™ï¸ Enrichment Pipeline

```text
[Normalized Finding]
        â†“
[CPE Identifier Extraction]
        â†“
[CVE Resolver (NVD, OSV, Vulners)]
        â†“
[CWE / OWASP Mapping]
        â†“
[CVSS Calculation]
        â†“
[POC + Exploit Lookup]
        â†“
[MITRE ATT&CK Correlation]
        â†“
[Final Enriched Finding]
```text

---

## ðŸ§© CPE & Component Extraction

The enrichment process begins by fingerprinting software components.

```python
def extract_cpe(finding: Finding) -> Optional[str]:
    headers = finding.evidence.get("response", {}).get("headers", {})
    banner = headers.get("Server") or headers.get("X-Powered-By")
    return cpe_guess(banner) if banner else None
```python

### Example results:
- `Server: Apache/2.4.54` â†’ `cpe:/a:apache:http_server:2.4.54`
- `X-Powered-By: Express` â†’ `cpe:/a:npmjs:express:4.18.2`

## ðŸ§© CVE Resolution Engine

The CVE Resolver queries multiple backends in a failover chain:

| Source | Endpoint | Rate Limit | Cache TTL |
|--------|----------|------------|-----------|
| **NVD** | `https://services.nvd.nist.gov/rest/json/cves/2.0` | 1000/day | 24h |
| **OSV.dev** | `https://api.osv.dev/v1/query` | Unlimited | 12h |
| **Vulners API** | `https://vulners.com/api/v3/search/lucene/` | 2000/day | 24h |

```python
class CVEResolver:
    def resolve(self, cpe: str) -> List[dict]:
        cached = self.cache.get(cpe)
        if cached: return cached

        results = []
        for backend in self.backends:
            try:
                results.extend(backend.query(cpe))
            except Exception:
                continue
        self.cache.set(cpe, results)
        return results
```python

Results are merged and normalized into a unified CVE format.

## ðŸ§  CVE Normalized Model

```python
class CVEEntry(BaseModel):
    cve_id: str
    description: str
    published: datetime
    cvss_score: float
    cvss_vector: str
    cwe_ids: List[int]
    references: List[str]
    exploit_refs: List[str]
    source: str
```python

Each finding may be associated with multiple CVE entries.

## ðŸ§© CWE / OWASP / MITRE Mapping

Once CVEs are linked, weaknesses and behavioral context are resolved.

| Source | Purpose | Mapping Strategy |
|--------|---------|------------------|
| **CWE** | Weakness classification | CVE â†’ CWE via NVD JSON |
| **OWASP** | Application risk class | CWE â†’ OWASP Top 10 map |
| **MITRE ATT&CK** | Adversary tactics/techniques | CWE â†’ ATT&CK TID correlation |

```python
def map_cwe_to_owasp(cwe_id: int) -> str:
    mapping = {
        79: "A03: Injection",
        89: "A03: Injection",
        787: "A05: Buffer Overflow",
        601: "A10: SSRF"
    }
    return mapping.get(cwe_id, "N/A")
```python

### MITRE correlation example:
```python
mitre_map = {
    "CWE-79": "T1059.007 (Cross-Site Scripting)",
    "CWE-89": "T1505.003 (SQL Injection)"
}
```python

## ðŸ§© CVSS Calculation

If a finding lacks explicit CVSS scoring, SecFlow derives one via heuristics:

```python
def derive_cvss(cwe_id: int, context: dict) -> float:
    # basic fallback estimation
    if cwe_id in (79, 89):
        return 9.0
    elif cwe_id in (200, 201):
        return 7.5
    return 5.0
```python

### Final score combines:
```python
base = CVSS
temporal = exploit_availability * 0.2
environmental = exposure_factor * 0.3
final = (base + temporal + environmental) / 1.5
```python

## ðŸ§  PoC & Exploit Correlation

### Data Sources
| Source | Access | Notes |
|--------|--------|-------|
| **Exploit-DB** | Public dump | Weekly sync |
| **Vulners** | API | Indexed by CVE |
| **Metasploit** | Local metadata | Optional |
| **GitHub PoC** | OSV + GitHub GraphQL | Filter by repo tags |
| **SecurityFocus (legacy)** | Offline mirror | Static references |

### Example Resolver
```python
def resolve_poc(cve_id: str) -> list:
    sources = [exploitdb, vulners, githubpoc]
    results = []
    for s in sources:
        results.extend(s.search(cve_id))
    return list(set(results))
```python

## ðŸ§© PoC Safety Governance

Because PoCs can contain malicious payloads, SecFlow enforces strict isolation.

| Policy | Enforcement |
|--------|-------------|
| **Read-only storage** | PoCs stored as text blobs, no exec permission |
| **Sandbox validation** | Hash-check before use |
| **Legal disclaimer** | Must be accepted before PoC download |
| **Runtime restriction** | Execution allowed only in `--sandbox` mode |

### Example governance guard:
```python
def safe_open_poc(poc_path: Path):
    if not user.accepted_disclaimer:
        raise PermissionError("PoC execution disabled until disclaimer accepted.")
    subprocess.run(["sandbox", "python3", poc_path])
```python

## ðŸ§© Caching & Synchronization

Each enrichment source maintains a versioned local cache:

| Component | Backend | Format | TTL |
|-----------|---------|--------|-----|
| **CVE** | NVD JSON | SQLite | 24h |
| **CWE** | MITRE XML | JSON | 7d |
| **PoC** | Exploit-DB | FS/JSON | 14d |

### Example cache adapter:
```python
class LocalCache:
    def get(self, key: str) -> Optional[Any]:
        """Get value from cache by key."""
        pass
    
    def set(self, key: str, value: Any, ttl: int) -> None:
        """Set value in cache with TTL."""
        pass
    
    def purge_expired(self) -> None:
        """Remove expired entries from cache."""
        pass
```python

## ðŸ§© API Exposure

The enrichment system provides a unified query interface:

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/v1/enrich/cve` | POST | Enrich a finding by CPE/CVE |
| `/api/v1/enrich/cwe` | POST | Map CWE to OWASP |
| `/api/v1/enrich/poc` | GET | Retrieve PoC links |
| `/api/v1/enrich/status` | GET | Show cache health |

### Example response:
```json
{
  "finding_id": "1234",
  "cve": ["CVE-2024-12345"],
  "CVSS": 9.8,
  "cwe": 89,
  "owasp": "A03: Injection",
  "poc_links": ["https://exploit-db.com/exploits/52341"]
}
```json

## ðŸ§© Enrichment Rules & Priority

1. Local cache first
2. API sources (NVD/OSV) second
3. Third-party mirrors (Vulners, Exploit-DB) last

Each backend includes retry and circuit-breaker logic via Tenacity.

## ðŸ§© Parallel Enrichment

The enrichment worker uses async pipelines for batch enrichment:

```python
async def enrich_findings_batch(findings: list):
    async with aiohttp.ClientSession() as session:
        tasks = [enrich_one(f, session) for f in findings]
        return await asyncio.gather(*tasks)
```python

Each finding may take 0.1â€“1.5 seconds depending on CVE count; concurrency keeps throughput high.

## ðŸ§  Example Enrichment Output

```json
{
  "finding_id": "abcd-1234",
  "cpe": "cpe:/a:apache:http_server:2.4.54",
  "cve_ids": ["CVE-2023-25690"],
  "cwe": 89,
  "owasp": "A03: Injection",
  "cvss_score": 9.8,
  "poc_links": ["https://exploit-db.com/exploits/52341"],
  "mitre_tid": "T1505.003",
  "last_enriched": "2025-10-06T09:43:00Z"
}
```

## ðŸ”’ Security & Compliance

- All enrichment data is public-source only.
- No proprietary or restricted databases.
- Caching system automatically purges expired CVE entries.
- Full audit trail for every enrichment event.

## ðŸ”® Future Enhancements

- Integrate VulnCheck, CISA KEV, and EPSS for exploit prediction.
- Introduce AI-based CVE clustering for semantic matching.
- Enrichment correlation graph for cross-project analysis.
- Automated risk re-scoring based on KEV updates.

---

**Next:** [POC Sources, Safety & Legal Guidelines](14-poc-sources-and-legal-guidelines.md)
